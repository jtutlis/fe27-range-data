<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>


<svg width=960 height=600>
</svg>

<div id="info">
</div>

<script>

  // adapted for d3.v5 from d3js in action

  Promise.all([
    d3.json('/data/all.geojson')
  ]).then(([countries]) => {
    createMap(countries)
  })

  function createMap(countries) {

    var proj = d3.geoMercator()
      .center([132, -28])
      .translate([960 / 2, 600 / 2])
      .scale(1000);
    //    .translate(250, 250) <- THIS WAS THE CULPRIT. CORRECT LINE BELOW
    //    .translate([250, 250])
    //    .scale(120);

    //  var proj = d3.geoSatellite()
    //    .scale(1330)
    //    .translate([250,250])
    //    .rotate([-30.24, -31, -56])
    //    .tilt(15)
    //    .distance(1.150)
    //    .clipAngle(45);

    var gpath = d3.geoPath()
      .projection(proj);

    var ccolor =
      d3.scaleSequential(d3.interpolateBlues)
        .domain(
          d3.extent(countries.features, d => gpath.area(d))
        );

    console.log(d3.extent(countries.features, d => gpath.area(d)));

    console.log(gpath.area(countries.features[0]))

    d3.select('svg')
      .selectAll('path')
      .data(countries.features)
      .enter()
      .append('path')
      .attr('d', gpath)
      .attr('stroke-width', 1)
      .attr('stroke', '#252525')
      .attr('fill', d => ccolor(gpath.area(d)))
      .style("opacity", 0.25)
      .on('mouseover', function (d) {
        console.log(d.properties.BINOMIAL);
        d3.select('#info').text(d.properties.BINOMIAL);
      })

    // FOR MORE ON THIS, SEE ARTICLE THINKING WITH JOINS
    // d3.select('svg')
    //   .selectAll('circle')
    //   .data(cities)
    //   .enter()
    //   .append('circle')
    //   .attr('r', 3)
    //   .attr('cx', d => proj([d.x, d.y])[0])
    //   .attr('cy', d => proj([d.x, d.y])[1])
    //   .attr('stroke-width', 1)
    //   .attr('stroke', '#4F442B')
    //   .attr('fill', '#FCBC34')
    //   .on('mouseover', function(d) {
    //     d3.select('#info').text(d.label);
    //   })

    var mapZoom = d3.zoom()
      .on('zoom', zoomed);

    var zoomSettings = d3.zoomIdentity
      .translate(250, 250)
      .scale(420);

    d3.select('svg')
      .call(mapZoom)
      .call(mapZoom.transform, zoomSettings);

    function zoomed() {
      var e = d3.event;

      proj
        .translate([e.transform.x, e.transform.y])
        .scale(e.transform.k);

      d3.selectAll('path')
        .attr('d', gpath);

      d3.selectAll('circle')
        .attr('cx', d => proj([d.x, d.y])[0])
        .attr('cy', d => proj([d.x, d.y])[1]);
    }
  }

</script>